require 'rake/clean'
require 'albacore'

PACKAGES = './Packages'
LIB = './lib'

CONTENT_ASSETS = 'src\TopDownShooterSpike\Content'
CONTENT_BIN = 'src\TopDownShooterSpike\bin\WindowsGL\Debug\Content'
CONTENT_COMPILER_EXE = %{"#{LIB}/Content Compiler/bin/XNAContentCompiler.exe"}

CONTENT_SLN = './lib/Content Compiler/XNAContentCompiler.sln'
TDS_SLN = 'src/TopDownShooterSpike.sln'

CLOBBER.include('src/**/bin/*', 'lib/**/bin', '**/obj/*', CONTENT_BIN)
CLEAN.include("#{CONTENT_BIN}")

desc 'builds the solution and compiles content'
task :default => ['clobber', 'compile:solution', 'compile:content_solution', 'compile:content']

desc 'Watches for content file changes'
task :watch => ['compile:watch']

desc 'builds the solution'
task :build => ['compile:solution']

desc 'builds the content solution'
task :build_tool => ['compile:content_solution']

desc 'opens content compiler gui'
task :tool do
  sh %{#{CONTENT_COMPILER_EXE}}
end

desc 'travis build task'
task 'travis-ci' => ['ci:solution'] do
end

namespace :compile do

  desc 'compiles content assets'
  task :content do
    sh %{#{CONTENT_COMPILER_EXE} build #{CONTENT_ASSETS} #{CONTENT_BIN}}
  end

  task :watch do
    sh %{#{CONTENT_COMPILER_EXE} watch #{CONTENT_ASSETS} #{CONTENT_BIN}}
  end

  task :solution  do
    Rake::Task['compile:build_solution'].invoke "#{TDS_SLN}"
  end

  task :content_solution do
    Rake::Task['compile:build_solution'].invoke "#{CONTENT_SLN}"
  end

  msbuild :build_solution, [:path] do |msb, args|
    if args.path == nil
      raise "path cannot be empty"
    end

    msb.targets = [:Clean, :Build]
    msb.solution = args.path;
    Rake::Task['compile:build_solution'].reenable
  end
end

namespace :ci do

  task :solution do 
    sh "xbuild #{TDS_SLN}"
  end

  task :build_dependencies do
    # build all .slns in the lib folder, copy artifacts to /Packages
  end
end
